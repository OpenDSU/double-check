<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Report</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <style>
        .table > tbody > tr > td,
        .table > tbody > tr > th {
            border-top: none;
        }

        .testsTableHeader {
            display: flex;
            justify-content: space-between;
        }

        .testsTableHeader > h4 {
            margin: 0;
        }

        .table-filter-area {
            display: flex;
            margin-bottom: 5px
        }

        .table-filter-area > button:first-child {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }

        .table-filter-area > button:last-child {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }

        .table-filter-area > button:not(:first-child):not(:last-child) {
            border-radius: 0;
        }

        .failedTestDetailsCard {
            padding: 0.7rem 1rem;
        }

        .run {
            border-bottom: solid 2px #e8e8e8;
        }

        .run:last-child {
            border-bottom: none;
        }

        .run > p:last-child {
            margin-bottom: 0;
        }

        .run > h6:first-child {
            margin-top: 0.7rem;
        }

        .run:first-child > h6:first-child {
            margin-top: 0;
        }

        .detailsButton {
            padding-top: 0;
            padding-bottom: 0;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>


<div class="container">
    <h3 id="resultsTimestamp">Results from 28/06/2018</h3>
    <h4>Summary</h4>
    <table class="table table-striped">
        <thead>
        <tr>
            <th scope="col">Tests</th>
            <th scope="col">Succeeded</th>
            <th scope="col">Failed</th>
            <th scope="col">Success Rate</th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td id="totalTestsNumber"></td>
            <td id="totalTestsSucceeded"></td>
            <td id="totalTestsFailed"></td>
            <td>
                <div class="progress" style="height: 22px">
                    <div class="progress-bar bg-success" role="progressbar" id="testsSuccessRate" style="width: 0;"
                         aria-valuenow="50"
                         aria-valuemin="0" aria-valuemax="100">
                    </div>
                </div>
            </td>
        </tr>
        </tbody>
    </table>

    <div class="testsTableHeader">
        <h4>Tests</h4>
        <div class="table-filter-area">
            <button type="button" class="btn btn-primary btn-rounded btn-sm my-0"
                    onclick="filterByStatus(STATUS.ALL)">All
            </button>
            <button type="button" class="btn btn-primary btn-sm my-0"
                    onclick="filterByStatus(STATUS.PASSED)">Passed
            </button>
            <button type="button" class="btn btn-primary btn-rounded btn-sm my-0"
                    onclick="filterByStatus(STATUS.FAILED)">Failed
            </button>
        </div>
    </div>
    <div class="table-responsive">
        <table class="table table-sm" id="resultsTable">
            <thead>
            <tr>
                <th scope="col">Path</th>
                <th scope="col">Status</th>
                <th scope="col"></th>
            </tr>
            </thead>
            <tbody id="resultsTableBody">
            </tbody>
        </table>
    </div>
</div>


<script>

    const passTestTemplate = () => `
    <tr class="table-success">
            <td>{{path}}</td>
            <td>Passed</td>
            <td></td>
        </tr>
    `;

    const failTestTemplate = () => `
     <tr class="table-danger">
            <td>{{path}}</td>
            <td>Failed</td>
            <td><button type="button" class="btn btn-primary btn-rounded btn-sm my-0 detailsButton" onclick="toggleView('collapse-area-{{index}}')">Details</button></td>
        </tr>
        <tr class="collapse" id="collapse-area-{{index}}">
            <td colspan="3" style="padding: 0;">
                <div class="card card-body failedTestDetailsCard">
                    {{runsResults}}
                </div>
            </td>
        </tr>
    `;

    const runTemplate = () => '<div class="run"></div>';

    const STATUS = {
        FAILED: 'failed',
        PASSED: 'passed',
        ALL: 'all'
    };

    // Utils functions
    String.prototype.capitalize = function () {
        return this.charAt(0).toUpperCase() + this.slice(1);
    };

    function __element(id) {
        return document.getElementById(id);
    }

    /**
     * Replaces {{key}} in source with value of tags[key]
     * @param source
     * @param tags
     * @returns {string}
     * @private
     */
    function __interpolation(source, tags) {
        const regex = /({{)(\w+)(}})/gim;

        function replacer(match, braces1, word) {
            let result = '';
            if (tags && tags[word]) {
                result = tags[word];
            }
            return result;
        }

        return source.replace(regex, replacer);
    }

    function toggleView(id) {
        const el = document.getElementById(id);
        if (el.classList.contains('show')) {
            el.classList.remove('show');
        } else {
            el.classList.add('show');
        }
    }

    function filterByStatus(status) {
        renderTestsTable(status);
    }

    /**
     * Sets data from testRunner.js to window and starts rendering the page
     * @param testsResults
     * @param timestamp
     */
    function init(testsResults, timestamp) {
        window.testsResults = testsResults;
        window.testsTimestamp = timestamp;
        renderPage();
    }

    function renderPage() {
        // render summary area
        __element('resultsTimestamp').innerText = 'Results from ' + new Date(window.testsTimestamp);
        __element('totalTestsNumber').innerText = window.testsResults.count;
        __element('totalTestsSucceeded').innerText = window.testsResults.passed.count;
        __element('totalTestsFailed').innerText = window.testsResults.failed.count;
        const successProgressBar = __element('testsSuccessRate');
        successProgressBar.innerText = Math.round(100 * window.testsResults.passed.count / window.testsResults.count) + '%';
        successProgressBar.style.width = successProgressBar.innerText;

        renderTestsTable(STATUS.ALL);
    }

    function renderTestsTable(status) {
        const tableElements = __element('resultsTable');
        if (status === STATUS.ALL) {
            // if table was previously rendered
            if (tableElements.rows.length > 1) {
                const tableElements = __element('resultsTable');
                Array.from(tableElements.rows).forEach(tableElement => {
                    if (tableElement.classList.contains('table-success')) {
                        tableElement.classList.remove('hidden');
                    } else if (tableElement.classList.contains('table-danger')) {
                        tableElement.classList.remove('hidden');
                    } else {
                        tableElement.classList.remove('show');
                    }
                });
            } else {
                // first run
                renderTestsTableByStatus(STATUS.FAILED);
                renderTestsTableByStatus(STATUS.PASSED);
            }
        } else if (status === STATUS.FAILED) {
            Array.from(tableElements.rows).forEach(tableElement => {
                if (tableElement.classList.contains('table-success')) {
                    tableElement.classList.add('hidden');
                } else if (tableElement.classList.contains('table-danger')) {
                    tableElement.classList.remove('hidden');
                } else {
                    tableElement.classList.remove('show');
                }
            });
        } else if (status === STATUS.PASSED) {
            Array.from(tableElements.rows).forEach(tableElement => {
                if (tableElement.classList.contains('table-success')) {
                    tableElement.classList.remove('hidden');
                } else if (tableElement.classList.contains('table-danger')) {
                    tableElement.classList.add('hidden');
                } else {
                    tableElement.classList.remove('show');
                }
            });
        }
    }

    function renderTestsTableByStatus(status) {
        const table = __element('resultsTableBody');

        let tableHtml = '';

        window.testsResults[status].items.forEach((test, index) => {
            test.index = index.toString();

            // prepare template for each run
            test.runsResults = '';

            if (test.reason) {
                test.reason.forEach(failedTestReason => {
                    const container = document.createElement('div');
                    container.innerHTML = runTemplate();
                    const containerContent = container.getElementsByTagName('div')[0];
                    containerContent.innerHTML = `<h6><b>Run ${failedTestReason.run} </b></h6>`;

                    Object.keys(failedTestReason.log).forEach(log => {
                        const logElement = document.createElement('p');
                        logElement.innerHTML = `${log.capitalize()}: ${prepareLog(log, failedTestReason.log[log])}`;
                        containerContent.appendChild(logElement);
                    });

                    test.runsResults += container.innerHTML;
                });
            }

            tableHtml += __interpolation(getTemplateByStatus(status), test);

        });

        table.innerHTML += tableHtml;
    }

    /**
     * Sanitize and format log details
     * @param key
     * @param value
     * @returns {*}
     */
    function prepareLog(key, value) {
        switch (key) {
            case 'timestamp':
                return new Date(value);
            case 'exception':
                return JSON.stringify(value);
            case 'stack': {
                return value.replace(/(<)/g, '&lt;').replace(/(?:\r\n|\r|\n)/g, '<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;');
            }
            default:
                return value;
        }
    }


    function getTemplateByStatus(status) {
        switch (status) {
            case STATUS.FAILED:
                return failTestTemplate();
            case STATUS.PASSED:
                return passTestTemplate();
            default:
                return '';
        }
    }

</script>

<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
        integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>
</body>
</html>